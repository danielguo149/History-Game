<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crossroads of History</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Crimson Text', Georgia, serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            color: #e8e8e8;
            overflow-x: hidden;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            padding: 40px 20px;
            border-bottom: 2px solid rgba(212, 175, 55, 0.3);
            margin-bottom: 30px;
        }

        h1 {
            font-family: 'Cinzel', serif;
            font-size: 3rem;
            color: #d4af37;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            margin-bottom: 10px;
            letter-spacing: 3px;
        }

        .subtitle {
            font-style: italic;
            color: #a0a0a0;
            font-size: 1.2rem;
        }

        .screen {
            display: none;
            animation: fadeIn 0.5s ease-in;
        }

        .screen.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .intro-text {
            text-align: center;
            font-size: 1.3rem;
            line-height: 1.8;
            margin: 30px 0;
            padding: 30px;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            border: 1px solid rgba(212, 175, 55, 0.2);
        }

        .period-selector {
            margin: 40px 0;
        }

        .period-selector h2 {
            font-family: 'Cinzel', serif;
            color: #d4af37;
            margin-bottom: 20px;
            text-align: center;
        }

        .language-selector {
            margin: 30px 0 10px;
            text-align: center;
        }

        .language-selector h2 {
            font-family: 'Cinzel', serif;
            color: #d4af37;
            margin-bottom: 15px;
        }

        .language-buttons {
            display: inline-flex;
            gap: 12px;
            padding: 10px;
            border-radius: 12px;
            background: rgba(0, 0, 0, 0.25);
            border: 1px solid rgba(212, 175, 55, 0.2);
        }

        .lang-btn {
            padding: 10px 18px;
            font-family: 'Cinzel', serif;
            font-size: 0.95rem;
            background: linear-gradient(145deg, #2a2a4a, #1a1a3a);
            border: 2px solid #4a4a6a;
            color: #d4af37;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .lang-btn.selected, .lang-btn:hover {
            background: linear-gradient(145deg, #d4af37, #b8960c);
            color: #1a1a2e;
            border-color: #d4af37;
            box-shadow: 0 4px 18px rgba(212, 175, 55, 0.35);
        }

        .period-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
        }

        .period-btn {
            padding: 15px 25px;
            font-family: 'Cinzel', serif;
            font-size: 1rem;
            background: linear-gradient(145deg, #2a2a4a, #1a1a3a);
            border: 2px solid #d4af37;
            color: #d4af37;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .period-btn:hover, .period-btn.selected {
            background: linear-gradient(145deg, #d4af37, #b8960c);
            color: #1a1a2e;
            transform: translateY(-3px);
            box-shadow: 0 5px 20px rgba(212, 175, 55, 0.4);
        }

        .start-btn {
            display: block;
            margin: 40px auto;
            padding: 20px 60px;
            font-family: 'Cinzel', serif;
            font-size: 1.3rem;
            background: linear-gradient(145deg, #8b0000, #5c0000);
            border: 2px solid #d4af37;
            color: #d4af37;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .start-btn:hover:not(:disabled) {
            background: linear-gradient(145deg, #a50000, #700000);
            transform: scale(1.05);
            box-shadow: 0 5px 30px rgba(139, 0, 0, 0.5);
        }

        .start-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .custom-era,
        .custom-context {
            margin-top: 20px;
            padding: 18px;
            background: rgba(0,0,0,0.25);
            border: 1px solid rgba(212, 175, 55, 0.2);
            border-radius: 12px;
        }

        .custom-era p,
        .custom-context p {
            color: #d4af37;
            margin-bottom: 10px;
            font-family: 'Cinzel', serif;
        }

        .custom-era-input,
        .custom-context-input {
            width: 100%;
            padding: 12px 14px;
            font-family: 'Crimson Text', serif;
            font-size: 1rem;
            background: linear-gradient(145deg, #2a2a4a, #1a1a3a);
            border: 2px solid #4a4a6a;
            color: #e8e8e8;
            border-radius: 8px;
            resize: vertical;
        }

        .custom-era-input:focus,
        .custom-context-input:focus {
            outline: none;
            border-color: #d4af37;
        }

        .custom-era-input::placeholder,
        .custom-context-input::placeholder {
            color: #666;
        }

        .custom-context-note {
            margin-top: 8px;
            color: #888;
            font-size: 0.9rem;
        }

        .scenario-card {
            background: linear-gradient(145deg, rgba(30, 30, 50, 0.9), rgba(20, 20, 40, 0.9));
            border: 2px solid rgba(212, 175, 55, 0.4);
            border-radius: 15px;
            padding: 30px;
            margin: 20px 0;
        }

        .era-badge {
            display: inline-block;
            padding: 5px 15px;
            background: rgba(212, 175, 55, 0.2);
            border: 1px solid #d4af37;
            border-radius: 20px;
            font-size: 0.9rem;
            color: #d4af37;
            margin-bottom: 15px;
        }

        .leader-name {
            font-family: 'Cinzel', serif;
            font-size: 1.8rem;
            color: #d4af37;
            margin-bottom: 5px;
        }

        .leader-title {
            font-style: italic;
            color: #888;
            margin-bottom: 20px;
        }

        .scenario-context {
            font-size: 1.1rem;
            line-height: 1.7;
            margin-bottom: 25px;
            padding: 20px;
            background: rgba(0,0,0,0.3);
            border-left: 3px solid #d4af37;
            border-radius: 0 10px 10px 0;
        }

        .dilemma {
            font-size: 1.2rem;
            font-weight: 600;
            color: #ff6b6b;
            margin-bottom: 25px;
            text-align: center;
        }

        .choices {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .choice-btn {
            padding: 20px;
            font-family: 'Crimson Text', serif;
            font-size: 1.1rem;
            background: linear-gradient(145deg, #2a2a4a, #1a1a3a);
            border: 2px solid #4a4a6a;
            color: #e8e8e8;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
        }

        .choice-btn:hover:not(:disabled) {
            border-color: #d4af37;
            background: linear-gradient(145deg, #3a3a5a, #2a2a4a);
            transform: translateX(10px);
        }

        .choice-btn:disabled {
            cursor: not-allowed;
            opacity: 0.7;
        }

        .choice-btn.selected {
            border-color: #4ecdc4;
            background: rgba(78, 205, 196, 0.2);
        }

        .choice-btn.historical {
            border-color: #d4af37 !important;
            background: rgba(212, 175, 55, 0.2) !important;
        }

        .result-card {
            background: linear-gradient(145deg, rgba(30, 30, 50, 0.95), rgba(20, 20, 40, 0.95));
            border: 2px solid rgba(212, 175, 55, 0.4);
            border-radius: 15px;
            padding: 30px;
            margin: 20px 0;
        }

        .result-header {
            font-family: 'Cinzel', serif;
            font-size: 1.5rem;
            color: #d4af37;
            margin-bottom: 20px;
            text-align: center;
        }

        .result-section {
            padding: 20px;
            margin: 15px 0;
            border-radius: 10px;
            line-height: 1.7;
        }

        .your-choice {
            background: rgba(78, 205, 196, 0.15);
            border-left: 4px solid #4ecdc4;
        }

        .historical-choice {
            background: rgba(212, 175, 55, 0.15);
            border-left: 4px solid #d4af37;
        }

        .alternate-history {
            background: rgba(255, 107, 107, 0.15);
            border-left: 4px solid #ff6b6b;
        }

        .fun-fact {
            background: rgba(147, 112, 219, 0.15);
            border-left: 4px solid #9370db;
        }

        .lesson {
            background: rgba(100, 149, 237, 0.15);
            border-left: 4px solid #6495ed;
        }

        .section-title {
            font-family: 'Cinzel', serif;
            font-size: 1.1rem;
            margin-bottom: 10px;
        }

        .your-choice .section-title { color: #4ecdc4; }
        .historical-choice .section-title { color: #d4af37; }
        .alternate-history .section-title { color: #ff6b6b; }
        .fun-fact .section-title { color: #9370db; }
        .lesson .section-title { color: #6495ed; }

        .match-indicator {
            text-align: center;
            padding: 15px;
            margin: 20px 0;
            border-radius: 10px;
            font-family: 'Cinzel', serif;
            font-size: 1.2rem;
        }

        .match-indicator.matched {
            background: rgba(78, 205, 196, 0.2);
            color: #4ecdc4;
            border: 2px solid #4ecdc4;
        }

        .match-indicator.different {
            background: rgba(255, 107, 107, 0.2);
            color: #ff6b6b;
            border: 2px solid #ff6b6b;
        }

        .btn {
            display: inline-block;
            margin: 10px;
            padding: 15px 40px;
            font-family: 'Cinzel', serif;
            font-size: 1.1rem;
            background: linear-gradient(145deg, #2a2a4a, #1a1a3a);
            border: 2px solid #d4af37;
            color: #d4af37;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn:hover:not(:disabled) {
            background: linear-gradient(145deg, #d4af37, #b8960c);
            color: #1a1a2e;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .button-container {
            text-align: center;
            margin-top: 30px;
        }

        .score-display {
            text-align: center;
            padding: 20px;
            margin: 20px 0;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
        }

        .score-display h3 {
            font-family: 'Cinzel', serif;
            color: #d4af37;
            margin-bottom: 10px;
        }

        .score-number {
            font-size: 2rem;
            color: #4ecdc4;
            font-weight: bold;
        }

        .progress-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-size: 0.9rem;
            color: #888;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(0,0,0,0.3);
            border-radius: 4px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #d4af37, #4ecdc4);
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .loading {
            text-align: center;
            padding: 60px 20px;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(212, 175, 55, 0.2);
            border-top-color: #d4af37;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            font-family: 'Cinzel', serif;
            color: #d4af37;
            font-size: 1.2rem;
            animation: pulse 1.5s ease-in-out infinite;
        }

        .final-screen {
            text-align: center;
            padding: 40px 20px;
        }

        .final-score {
            font-size: 4rem;
            color: #d4af37;
            font-family: 'Cinzel', serif;
            margin: 20px 0;
        }

        .verdict {
            font-size: 1.3rem;
            margin: 20px 0;
            padding: 20px;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            line-height: 1.6;
        }

        .leaders-list {
            text-align: left;
            padding: 20px;
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
            margin: 20px 0;
        }

        .leaders-list h3 {
            font-family: 'Cinzel', serif;
            color: #d4af37;
            margin-bottom: 15px;
            text-align: center;
        }

        .leader-item {
            padding: 8px 0;
            border-bottom: 1px solid rgba(212, 175, 55, 0.1);
            display: flex;
            justify-content: space-between;
        }

        .leader-item:last-child {
            border-bottom: none;
        }

        .leader-item .match-icon {
            color: #4ecdc4;
        }

        .leader-item .diff-icon {
            color: #ff6b6b;
        }

        footer {
            text-align: center;
            padding: 30px;
            margin-top: 40px;
            border-top: 1px solid rgba(212, 175, 55, 0.2);
            color: #666;
        }

        .error-message {
            background: rgba(255, 107, 107, 0.2);
            border: 2px solid #ff6b6b;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            margin: 20px 0;
        }

        .error-message h3 {
            color: #ff6b6b;
            margin-bottom: 10px;
        }

        .api-key-section {
            margin: 30px 0;
            padding: 25px;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            border: 1px solid rgba(212, 175, 55, 0.2);
        }

        .api-key-section h2 {
            font-family: 'Cinzel', serif;
            color: #d4af37;
            margin-bottom: 10px;
            text-align: center;
            font-size: 1.3rem;
        }

        .api-help {
            text-align: center;
            color: #888;
            font-size: 0.95rem;
            margin-bottom: 15px;
        }

        .api-help a {
            color: #4ecdc4;
            text-decoration: none;
        }

        .api-help a:hover {
            text-decoration: underline;
        }

        .api-input-group {
            display: flex;
            gap: 10px;
            max-width: 600px;
            margin: 0 auto;
        }

        .api-select {
            padding: 12px 15px;
            font-family: 'Crimson Text', serif;
            font-size: 1rem;
            background: linear-gradient(145deg, #2a2a4a, #1a1a3a);
            border: 2px solid #4a4a6a;
            color: #e8e8e8;
            border-radius: 8px;
            cursor: pointer;
            min-width: 150px;
        }

        .api-select:focus {
            outline: none;
            border-color: #d4af37;
        }

        .api-input {
            flex: 1;
            padding: 12px 15px;
            font-family: 'Crimson Text', serif;
            font-size: 1rem;
            background: linear-gradient(145deg, #2a2a4a, #1a1a3a);
            border: 2px solid #4a4a6a;
            color: #e8e8e8;
            border-radius: 8px;
        }

        .api-input:focus {
            outline: none;
            border-color: #d4af37;
        }

        .api-input::placeholder {
            color: #666;
        }

        .api-note {
            text-align: center;
            color: #666;
            font-size: 0.85rem;
            margin-top: 10px;
        }

        @media (max-width: 600px) {
            h1 { font-size: 2rem; }
            .period-btn { padding: 10px 15px; font-size: 0.9rem; }
            .scenario-card, .result-card { padding: 20px; }
            .final-score { font-size: 3rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Crossroads of History</h1>
            <p class="subtitle">Walk in the footsteps of legends. Make the choices that shaped our world.</p>
        </header>

        <!-- Intro Screen -->
        <div class="screen active" id="introScreen">
            <div class="intro-text">
                <p>Throughout history, leaders have faced impossible choices &mdash; decisions that would echo through centuries and reshape the fate of nations.</p>
                <br>
                <p>Now, <strong>you</strong> stand at these crossroads. Will you choose as they did? Or forge a different path?</p>
                <br>
                <p>After each choice, discover what really happened &mdash; and what might have been.</p>
            </div>

            <div class="language-selector">
                <h2>Language / 语言</h2>
                <div class="language-buttons" id="languageButtons">
                    <button class="lang-btn selected" data-lang="en">English</button>
                    <button class="lang-btn" data-lang="zh">中文</button>
                </div>
            </div>

            <div class="period-selector">
                <h2 id="eraTitle">Choose Your Era</h2>
                <div class="period-buttons" id="periodButtons">
                    <button class="period-btn selected" data-period="all">All Eras</button>
                    <button class="period-btn" data-period="ancient">Ancient World</button>
                    <button class="period-btn" data-period="medieval">Medieval</button>
                    <button class="period-btn" data-period="renaissance">Renaissance</button>
                    <button class="period-btn" data-period="modern">Modern Era</button>
                    <button class="period-btn" data-period="contemporary">20th Century</button>
                </div>
                <div class="custom-era">
                    <p id="customEraLabel">Or enter a custom time period:</p>
                    <input type="text" id="customEraInput" class="custom-era-input" placeholder="e.g., Tang Dynasty China, Viking Age, Aztec Empire...">
                </div>
                <div class="custom-context">
                    <p id="customContextLabel">Add your own historical context (optional):</p>
                    <textarea id="customContextInput" class="custom-context-input" rows="4" placeholder="e.g., Focus on trade disputes, religious reforms, or a looming invasion..."></textarea>
                    <div class="custom-context-note" id="customContextNote">We will weave this into the scenario while keeping it historically accurate.</div>
                </div>
            </div>

            <button class="start-btn" id="startBtn">Begin Your Journey</button>
        </div>

        <!-- Game Screen -->
        <div class="screen" id="gameScreen">
            <div id="gameContent"></div>
        </div>

        <!-- Result Screen -->
        <div class="screen" id="resultScreen">
            <div id="resultContent"></div>
        </div>

        <!-- Final Screen -->
        <div class="screen" id="finalScreen">
            <div id="finalContent"></div>
        </div>

        <footer>
            <p>Crossroads of History &mdash; Where every choice matters</p>
        </footer>
    </div>

    <script>
        // Game State
        const gameState = {
            selectedEra: 'all',
            currentScenario: null,
            roundNumber: 0,
            totalRounds: 5,
            score: 0,
            previousLeaders: [],
            previousEventKeys: [],
            previousEventSummaries: [],
            history: [],
            language: 'en'
        };

        const i18n = {
            en: {
                languageTitle: 'Language',
                eraTitle: 'Choose Your Era',
                allEras: 'All Eras',
                ancient: 'Ancient World',
                medieval: 'Medieval',
                renaissance: 'Renaissance',
                modern: 'Modern Era',
                contemporary: '20th Century',
                customEraLabel: 'Or enter a custom time period:',
                customEraPlaceholder: 'e.g., Tang Dynasty China, Viking Age, Aztec Empire...',
                customContextLabel: 'Add your own historical context (optional):',
                customContextPlaceholder: 'e.g., Focus on trade disputes, religious reforms, or a looming invasion...',
                customContextNote: 'We will weave this into the scenario while keeping it historically accurate.',
                startButton: 'Begin Your Journey',
                loadingScenario: 'Traveling through time...',
                loadingOutcome: 'Unraveling the threads of history...',
                connectionError: 'Connection Error',
                scenarioError: 'Unable to generate scenario. Please check that the server is running and try again.',
                outcomeError: 'Unable to generate outcome. Please try again.',
                tryAgain: 'Try Again',
                backToMenu: 'Back to Menu',
                continue: 'Continue',
                roundStatus: 'Round {current} of {total}',
                scoreStatus: 'Score: {score}/{outOf}',
                youChoseHistory: "You chose as history's pages record!",
                youChoseDifferent: 'You forged a different path than history',
                yourChoice: 'Your Choice',
                whatActuallyHappened: 'What Actually Happened',
                whatMightHaveBeen: 'What Might Have Been',
                didYouKnow: 'Did You Know?',
                lesson: 'The Lesson',
                currentScore: 'Current Score',
                nextChallenge: 'Next Challenge',
                finalResults: 'See Final Results',
                journeyComplete: 'Your Journey Complete',
                matchedHistoryLabel: "You matched history's choices:",
                leadersEncountered: 'Leaders Encountered',
                matched: 'Matched',
                different: 'Different',
                playAgain: 'Play Again',
                changeEra: 'Change Era',
                verdict80: 'Master Historian! You think like the great leaders of the past.',
                verdict60: "Keen Historical Mind! You have a strong sense for history's patterns.",
                verdict40: 'Independent Thinker! You march to the beat of your own drum.',
                verdict0: 'Revolutionary Spirit! Perhaps you would have changed history for the better.',
                footer: 'Crossroads of History — Where every choice matters'
            },
            zh: {
                languageTitle: '语言',
                eraTitle: '选择时代',
                allEras: '全部时代',
                ancient: '古代世界',
                medieval: '中世纪',
                renaissance: '文艺复兴',
                modern: '近代',
                contemporary: '20世纪',
                customEraLabel: '或输入自定义时代：',
                customEraPlaceholder: '例如：唐朝中国、维京时代、阿兹特克帝国……',
                customContextLabel: '添加你自己的历史背景（可选）：',
                customContextPlaceholder: '例如：聚焦贸易争端、宗教改革或迫在眉睫的入侵……',
                customContextNote: '我们会在保证历史准确性的前提下融入这些信息。',
                startButton: '开始旅程',
                loadingScenario: '穿越时空中...',
                loadingOutcome: '编织历史的线索中...',
                connectionError: '连接错误',
                scenarioError: '无法生成情境。请确认服务器正在运行后再试。',
                outcomeError: '无法生成结果。请再试一次。',
                tryAgain: '重试',
                backToMenu: '返回菜单',
                continue: '继续',
                roundStatus: '第 {current} 回合 / 共 {total} 回合',
                scoreStatus: '得分：{score}/{outOf}',
                youChoseHistory: '你的选择与历史一致！',
                youChoseDifferent: '你走出了一条不同的历史道路',
                yourChoice: '你的选择',
                whatActuallyHappened: '真实历史',
                whatMightHaveBeen: '另一种可能',
                didYouKnow: '你知道吗？',
                lesson: '启示',
                currentScore: '当前得分',
                nextChallenge: '下一挑战',
                finalResults: '查看最终结果',
                journeyComplete: '旅程完成',
                matchedHistoryLabel: '你与历史一致的选择：',
                leadersEncountered: '遇到的领袖',
                matched: '一致',
                different: '不同',
                playAgain: '再玩一次',
                changeEra: '更换时代',
                verdict80: '历史大师！你像过去的伟大领袖一样思考。',
                verdict60: '敏锐的历史感！你能把握历史的脉络。',
                verdict40: '独立思想者！你坚持自己的道路。',
                verdict0: '革命精神！也许你会让历史变得更好。',
                footer: '历史的十字路口 — 每个选择都至关重要'
            }
        };

        function t(key, variables = {}) {
            const strings = i18n[gameState.language] || i18n.en;
            let value = strings[key] || i18n.en[key] || '';
            Object.entries(variables).forEach(([name, replacement]) => {
                value = value.replace(`{${name}}`, replacement);
            });
            return value;
        }

        // DOM Elements
        const screens = {
            intro: document.getElementById('introScreen'),
            game: document.getElementById('gameScreen'),
            result: document.getElementById('resultScreen'),
            final: document.getElementById('finalScreen')
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            setupEventListeners();
            applyLanguage(gameState.language);
        });

        function setupEventListeners() {
            // Language selection
            document.getElementById('languageButtons').addEventListener('click', (e) => {
                if (e.target.classList.contains('lang-btn')) {
                    document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.remove('selected'));
                    e.target.classList.add('selected');
                    gameState.language = e.target.dataset.lang;
                    applyLanguage(gameState.language);
                }
            });

            // Period selection
            document.getElementById('periodButtons').addEventListener('click', (e) => {
                if (e.target.classList.contains('period-btn')) {
                    document.querySelectorAll('.period-btn').forEach(btn => btn.classList.remove('selected'));
                    e.target.classList.add('selected');
                    gameState.selectedEra = e.target.dataset.period;
                }
            });

            // Start button
            document.getElementById('startBtn').addEventListener('click', startGame);
        }

        function applyLanguage(lang) {
            const languageTitle = document.querySelector('.language-selector h2');
            if (languageTitle) {
                languageTitle.textContent = t('languageTitle');
            }

            document.getElementById('eraTitle').textContent = t('eraTitle');
            document.querySelector('[data-period="all"]').textContent = t('allEras');
            document.querySelector('[data-period="ancient"]').textContent = t('ancient');
            document.querySelector('[data-period="medieval"]').textContent = t('medieval');
            document.querySelector('[data-period="renaissance"]').textContent = t('renaissance');
            document.querySelector('[data-period="modern"]').textContent = t('modern');
            document.querySelector('[data-period="contemporary"]').textContent = t('contemporary');

            document.getElementById('customEraLabel').textContent = t('customEraLabel');
            document.getElementById('customEraInput').placeholder = t('customEraPlaceholder');
            document.getElementById('customContextLabel').textContent = t('customContextLabel');
            document.getElementById('customContextInput').placeholder = t('customContextPlaceholder');
            document.getElementById('customContextNote').textContent = t('customContextNote');
            document.getElementById('startBtn').textContent = t('startButton');

            const footer = document.querySelector('footer p');
            if (footer) {
                footer.textContent = t('footer');
            }
        }

        function showScreen(screenName) {
            Object.values(screens).forEach(screen => screen.classList.remove('active'));
            screens[screenName].classList.add('active');
        }

        async function startGame() {
            gameState.roundNumber = 0;
            gameState.score = 0;
            gameState.previousLeaders = [];
            gameState.previousEventKeys = [];
            gameState.previousEventSummaries = [];
            gameState.history = [];

            showScreen('game');
            await loadNextScenario();
        }

        async function loadNextScenario() {
            gameState.roundNumber++;

            const gameContent = document.getElementById('gameContent');
            gameContent.innerHTML = `
                <div class="progress-info">
                    <span>${t('roundStatus', { current: gameState.roundNumber, total: gameState.totalRounds })}</span>
                    <span>${t('scoreStatus', { score: gameState.score, outOf: gameState.roundNumber - 1 })}</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${((gameState.roundNumber - 1) / gameState.totalRounds) * 100}%"></div>
                </div>
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p class="loading-text">${t('loadingScenario')}</p>
                </div>
            `;

            try {
                const customEra = document.getElementById('customEraInput').value.trim();
                const customContext = document.getElementById('customContextInput').value.trim();
                const response = await fetch('/api/generate-scenario', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        era: gameState.selectedEra,
                        previousLeaders: gameState.previousLeaders,
                        previousEventKeys: gameState.previousEventKeys,
                        previousEventSummaries: gameState.previousEventSummaries,
                        language: gameState.language,
                        customEra,
                        customContext
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.details || 'Failed to generate scenario');
                }

                const scenario = await response.json();
                gameState.currentScenario = scenario;
                gameState.previousLeaders.push(scenario.leader);
                const eventKey = `${scenario.leader}||${scenario.era}||${scenario.dilemma}`;
                const eventSummary = `${scenario.leader} — ${scenario.era} — ${scenario.dilemma}`;
                gameState.previousEventKeys.push(eventKey);
                gameState.previousEventSummaries.push(eventSummary);

                displayScenario(scenario);
            } catch (error) {
                console.error('Error:', error);
                gameContent.innerHTML = `
                    <div class="error-message">
                        <h3>${t('connectionError')}</h3>
                        <p>${t('scenarioError')}</p>
                        <button class="btn" onclick="loadNextScenario()">${t('tryAgain')}</button>
                        <button class="btn" onclick="showScreen('intro')">${t('backToMenu')}</button>
                    </div>
                `;
            }
        }

        // Fisher-Yates shuffle
        function shuffleArray(array) {
            const arr = [...array];
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        }

        function displayScenario(scenario) {
            const gameContent = document.getElementById('gameContent');

            // Randomize choice order with proper shuffle
            const choices = shuffleArray(scenario.choices);

            gameContent.innerHTML = `
                <div class="progress-info">
                    <span>${t('roundStatus', { current: gameState.roundNumber, total: gameState.totalRounds })}</span>
                    <span>${t('scoreStatus', { score: gameState.score, outOf: gameState.roundNumber - 1 })}</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${((gameState.roundNumber - 1) / gameState.totalRounds) * 100}%"></div>
                </div>
                <div class="scenario-card">
                    <span class="era-badge">${scenario.era}</span>
                    <h2 class="leader-name">${scenario.leader}</h2>
                    <p class="leader-title">${scenario.title}</p>
                    <div class="scenario-context">${scenario.context}</div>
                    <p class="dilemma">${scenario.dilemma}</p>
                    <div class="choices" id="choicesContainer">
                        ${choices.map((choice) => `
                            <button class="choice-btn" data-historical="${choice.isHistorical}">
                                ${choice.text}
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;

            // Add click handlers for choices
            document.querySelectorAll('.choice-btn').forEach(btn => {
                btn.addEventListener('click', () => handleChoice(btn));
            });
        }

        async function handleChoice(button) {
            // Disable all buttons
            document.querySelectorAll('.choice-btn').forEach(btn => {
                btn.disabled = true;
            });

            const isHistorical = button.dataset.historical === 'true';
            const playerChoice = button.textContent.trim();

            button.classList.add('selected');

            // Mark historical choice
            document.querySelectorAll('.choice-btn').forEach(btn => {
                if (btn.dataset.historical === 'true') {
                    btn.classList.add('historical');
                }
            });

            if (isHistorical) {
                gameState.score++;
            }

            // Store in history
            gameState.history.push({
                leader: gameState.currentScenario.leader,
                matched: isHistorical
            });

            // Show loading state
            showScreen('result');
            document.getElementById('resultContent').innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p class="loading-text">${t('loadingOutcome')}</p>
                </div>
            `;

            try {
                const response = await fetch('/api/generate-outcome', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        scenario: gameState.currentScenario,
                        playerChoice: playerChoice,
                        isHistoricalChoice: isHistorical,
                        language: gameState.language
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.details || 'Failed to generate outcome');
                }

                const outcome = await response.json();
                displayOutcome(outcome, playerChoice, isHistorical);
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('resultContent').innerHTML = `
                    <div class="error-message">
                        <h3>${t('connectionError')}</h3>
                        <p>${t('outcomeError')}</p>
                        <button class="btn" onclick="continueGame()">${t('continue')}</button>
                    </div>
                `;
            }
        }

        function displayOutcome(outcome, playerChoice, isHistorical) {
            const resultContent = document.getElementById('resultContent');
            const scenario = gameState.currentScenario;

            resultContent.innerHTML = `
                <div class="result-card">
                    <h2 class="result-header">${scenario.leader}'s Decision</h2>

                    <div class="match-indicator ${isHistorical ? 'matched' : 'different'}">
                        ${isHistorical
                            ? t('youChoseHistory')
                            : t('youChoseDifferent')}
                    </div>

                    <div class="result-section your-choice">
                        <h3 class="section-title">${t('yourChoice')}</h3>
                        <p>${playerChoice}</p>
                    </div>

                    <div class="result-section historical-choice">
                        <h3 class="section-title">${t('whatActuallyHappened')}</h3>
                        <p>${outcome.whatActuallyHappened}</p>
                    </div>

                    <div class="result-section alternate-history">
                        <h3 class="section-title">${t('whatMightHaveBeen')}</h3>
                        <p>${outcome.alternateHistory}</p>
                    </div>

                    <div class="result-section fun-fact">
                        <h3 class="section-title">${t('didYouKnow')}</h3>
                        <p>${outcome.funFact}</p>
                    </div>

                    <div class="result-section lesson">
                        <h3 class="section-title">${t('lesson')}</h3>
                        <p>${outcome.lessonsLearned}</p>
                    </div>

                    <div class="score-display">
                        <h3>${t('currentScore')}</h3>
                        <span class="score-number">${gameState.score} / ${gameState.roundNumber}</span>
                    </div>

                    <div class="button-container">
                        ${gameState.roundNumber < gameState.totalRounds
                            ? `<button class="btn" onclick="continueGame()">${t('nextChallenge')}</button>`
                            : `<button class="btn" onclick="showFinalResults()">${t('finalResults')}</button>`
                        }
                    </div>
                </div>
            `;
        }

        function continueGame() {
            showScreen('game');
            loadNextScenario();
        }

        function showFinalResults() {
            showScreen('final');

            const percentage = Math.round((gameState.score / gameState.totalRounds) * 100);
            let verdict, verdictClass;

            if (percentage >= 80) {
                verdict = t('verdict80');
            } else if (percentage >= 60) {
                verdict = t('verdict60');
            } else if (percentage >= 40) {
                verdict = t('verdict40');
            } else {
                verdict = t('verdict0');
            }

            document.getElementById('finalContent').innerHTML = `
                <div class="final-screen">
                    <h2 style="font-family: 'Cinzel', serif; color: #d4af37; margin-bottom: 10px;">${t('journeyComplete')}</h2>
                    <p class="subtitle">${t('matchedHistoryLabel')}</p>
                    <div class="final-score">${gameState.score} / ${gameState.totalRounds}</div>
                    <div class="verdict">${verdict}</div>

                    <div class="leaders-list">
                        <h3>${t('leadersEncountered')}</h3>
                        ${gameState.history.map(h => `
                            <div class="leader-item">
                                <span>${h.leader}</span>
                                <span class="${h.matched ? 'match-icon' : 'diff-icon'}">
                                    ${h.matched ? `&#10003; ${t('matched')}` : `&#10007; ${t('different')}`}
                                </span>
                            </div>
                        `).join('')}
                    </div>

                    <div class="button-container">
                        <button class="btn" onclick="startGame()">${t('playAgain')}</button>
                        <button class="btn" onclick="showScreen('intro')">${t('changeEra')}</button>
                    </div>
                </div>
            `;
        }
    </script>
</body>
</html>
